<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Instantly - Internet Share</title>
    <link rel="icon" type="image/x-icon" href="./img/icon.ico" />
    <link
      href="https://fonts.googleapis.com/css2?family=Comfortaa&display=swap"
      rel="stylesheet"
    />

    <link rel="stylesheet" href="./css/tranfer.css" />
    <script
      src="https://code.jquery.com/jquery-3.6.0.min.js"
      integrity="sha256-/xUj+3OJU5yExlq6GSYGSHk7tPXikynS7ogEvDej/m4="
      crossorigin="anonymous"
    ></script>
  </head>
  <body>
    <script>
      function getParameterByName(name, url = window.location.href) {
        if (typeof URLSearchParams === "undefined" || typeof URL === "undefined") {
          name = name.replace(/[\[\]]/g, "\\$&");
          var regex = new RegExp("[?&]" + name + "(=([^&#]*)|&|#|$)"),
            results = regex.exec(url);
          if (!results) return null;
          if (!results[2]) return "";
          return decodeURIComponent(results[2].replace(/\+/g, " "));
        } else {
          const searchParams = new URLSearchParams(new URL(url).search);
          return searchParams.get(name) || null;
        }
      }
      var room_id;
      if (getParameterByName("room_id") == undefined) {
        room_id = (Math.random() + 1).toString(36).substring(2);
        window.location.href = window.location.href + "?room_id=" + room_id;
      } else room_id = getParameterByName("room_id");
    </script>
    <div class="container">
      <div class="col-left">
        <div class="left-box">
          <div class="waiting-area">
            <h2 style="color: white">Waiting for Peer</h2>
            <img src="./img/waitingForPeer.gif" />
          </div>

          <div class="drop-area" style="display: none">
            <p id="drop_zone_text">
              Drag one or more files to this <i>drop zone</i>.<br />
            </p>

            <div
              id="drop_zone"
              ondrop="dropHandler(event);"
              ondragover="dragOverHandler(event);"
            >
              <input type="file" id="fileinput" />
            </div>

            <br />
            <button id="sendFileBtn">send</button>
          </div>

          <div class="stats-area">
            <div class="fileprogress-box">
              <span id="filetransfer-text">Uploading</span>
              <span id="speed"></span> <br />
              <span id="filename-text"></span><br />
              <div class="progress" id="progress">0%</div>

              <div class="progress-bar">
                <div class="progress-bar-fill" style="height: 24px"></div>
              </div>
            </div>
          </div>
        </div>
      </div>
      <div class="col-right">
        <div class="right-box">
          <img src="./img/logo.jpg" height="186px" width="420" />
          <br />
          <br />
          <div class="roomcode-box">
            Room Link:<br />
            <input type="text" id="room_id" />
            <a id="copy" title="Copy to clipboard">
              <img src="./img/icons8-clone-figure-64.png" alt="copy icon" />
            </a>
          </div>
          <br />
          <msglist></msglist>
          <br />
          <div class="info-box">
            My Peer ID: <mypeerid></mypeerid>
            <br />

            <p class="speedlogs"></p>

            PeerList
            <list> </list>
          </div>
        </div>
      </div>
    </div>

    <script>
      function dragOverHandler(ev) {
        console.log("File(s) in drop zone");

        // Prevent default behavior (Prevent file from being opened)
        ev.preventDefault();
      }
      function dropHandler(ev) {
        console.log("File(s) dropped");

        // Prevent default behavior (Prevent file from being opened)
        ev.preventDefault();
        document.body.style.backgroundColor = "lightgreen";
        document.getElementById("fileinput").value =
          event.dataTransfer.getData("file");
        var filename = ev.dataTransfer.files[0].name;

        $("#drop_zone_text").html(filename + "<br>Start sending file now!");
        $("#sendFileBtn").show();
        $("#fileinput").hide();
      }

      $("document").ready(function () {
        $("#fileinput").change(function () {
          $("#drop_zone_text").html("File Dropped. Start sending file now!");
          $("#sendFileBtn").show();
        });
      });
    </script>

    <!-- Firebase App is always required and must be first -->
    <script src="https://www.gstatic.com/firebasejs/5.0.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/5.0.1/firebase-database.js"></script>

    <script>

      // Your web app's Firebase configuration
      const firebaseConfig = {
        apiKey: "AIzaSyAE7inEQPaHGgsnMx2CUrrlGRTpbip7RE0",
        authDomain: "webch-9ddf2.firebaseapp.com",
        databaseURL: "https://webch-9ddf2.firebaseio.com",
        projectId: "webch-9ddf2",
        storageBucket: "webch-9ddf2.appspot.com",
        messagingSenderId: "884619352461",
        appId: "1:884619352461:web:736f9656b77169ea6105c4",
      };

      // Initialize Firebase
      const app = firebase.initializeApp(firebaseConfig);
      // Initialize Realtime Database and get a reference to the service
      const database = firebase.database();

      // const database = getDatabase(app);
    </script>
    <script src="https://unpkg.com/peerjs@1.3.1/dist/peerjs.min.js"></script>
    <script type="module" src="./js/peerConnection.js"></script>
    <script type="module" src="./js/firebaseSignalingServer.js"></script>

    <script>
      $("#room_id").val(
        location.origin + location.pathname + "?room_id=" + room_id
      );
    </script>
    <script>
      $("#copy").click((e) => {
        $("#room_id").select();
        document.execCommand("copy");
        $("#copy").attr('title', 'copied');
      });   
    </script>
    <script type="module" src="./js/fileHandling.js"></script>
  </body>
</html>
